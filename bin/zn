#!/usr/bin/env php
<?php

use Untek\Core\App\Libs\ZnCore;
use Untek\Core\Container\Libs\Container;
use Untek\Core\DotEnv\Domain\Libs\Vlucas\VlucasBootstrap;
use Untek\Framework\Console\Domain\Factories\ConsoleApplicationFactory;

$_SERVER['MICRO_TIME'] = microtime(true);
$_SERVER['REQUEST_ID'] = uniqid();

require __DIR__ . '/../../../autoload.php';

/**
 * Инициализация ядра.
 *
 * Инициализируются/конфигурируются компоненты:
 * - DotEnv
 * - контейнер
 *   - EventDispatcher
 *   - ConfigManager
 *   - ContainerConfigurator
 * - загрузчик бандлов
 */
$container = new Container();
$znCore = new ZnCore($container);
$znCore->init();

$bootstrap = new VlucasBootstrap();
$mainEnv = $bootstrap->parseFile(__DIR__ . '/../../../../.env');
$localEnv = $bootstrap->parseFile(__DIR__ . '/../../../../.env.local');
$mainEnv = array_merge($mainEnv, $localEnv);

if(!empty($mainEnv['CONSOLE_APP_ENDPOINT'])) {
    $endpoint = str_replace('${ROOT_DIRECTORY}', realpath( __DIR__ . '/../../../..'), $mainEnv['CONSOLE_APP_ENDPOINT']);
    include $endpoint;
} else {
    $applicationFactory = new ConsoleApplicationFactory($container);
    $application = $applicationFactory->createApplicationInstance();
    $application->run();
}
